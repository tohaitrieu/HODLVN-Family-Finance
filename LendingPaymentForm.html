<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            margin: 0;
        }

        h2 {
            color: #4472C4;
            text-align: center;
            margin-top: 0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #4472C4;
        }

        .btn {
            background-color: #4472C4;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            background-color: #365899;
        }

        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .message {
            padding: 10px;
            margin-top: 15px;
            border-radius: 4px;
            display: none;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .required {
            color: red;
        }

        input[readonly] {
            background-color: #f0f0f0;
        }

        .total-display {
            font-size: 18px;
            font-weight: bold;
            color: #4472C4;
            text-align: right;
        }
    </style>
</head>

<body>
    <h2>üí∞ Thu H·ªìi N·ª£ & L√£i</h2>
    <form id="lendingPaymentForm">
        <div class="form-group">
            <label for="date">Ng√†y <span class="required">*</span></label>
            <input type="date" id="date" required>
        </div>

        <div class="form-group">
            <label for="borrowerName">Ng∆∞·ªùi vay <span class="required">*</span></label>
            <select id="borrowerName" required>
                <option value="">-- ƒêang t·∫£i... --</option>
            </select>
        </div>

        <div class="form-group">
            <label for="principal">Thu g·ªëc <span class="required">*</span></label>
            <input type="number" id="principal" required min="0" step="1000" placeholder="S·ªë ti·ªÅn g·ªëc thu v·ªÅ">
        </div>

        <div class="form-group">
            <label for="interest">Thu l√£i</label>
            <input type="number" id="interest" min="0" step="1000" value="0" placeholder="S·ªë ti·ªÅn l√£i thu v·ªÅ">
        </div>

        <div class="form-group">
            <label for="total">T·ªïng thu</label>
            <input type="text" id="total" readonly class="total-display" value="0">
        </div>

        <div class="form-group">
            <label for="note">Ghi ch√∫</label>
            <textarea id="note" rows="3" placeholder="Th√™m ghi ch√∫ (kh√¥ng b·∫Øt bu·ªôc)"></textarea>
        </div>

        <button type="submit" class="btn" id="submitBtn">
            üí∞ X√°c nh·∫≠n thu ti·ªÅn
        </button>
    </form>

    <div id="message" class="message"></div>

    <script>
        document.getElementById('date').valueAsDate = new Date();

        // Load danh s√°ch ng∆∞·ªùi vay
        window.onload = function () {
            google.script.run
                .withSuccessHandler(function (list) {
                    const select = document.getElementById('borrowerName');
                    select.innerHTML = '<option value="">-- Ch·ªçn ng∆∞·ªùi vay --</option>';
                    list.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        select.appendChild(option);
                    });
                })
                .withFailureHandler(function (error) {
                    const select = document.getElementById('borrowerName');
                    select.innerHTML = '<option value="">L·ªói t·∫£i danh s√°ch</option>';
                    showMessage('Kh√¥ng th·ªÉ t·∫£i danh s√°ch: ' + error.message, 'error');
                })
                .getLendingList();
        };

        // T√≠nh t·ª± ƒë·ªông t·ªïng thu
        function calculateTotal() {
            const principal = parseFloat(document.getElementById('principal').value) || 0;
            const interest = parseFloat(document.getElementById('interest').value) || 0;
            const total = principal + interest;
            document.getElementById('total').value = total.toLocaleString('vi-VN');
        }

        document.getElementById('principal').addEventListener('input', calculateTotal);
        document.getElementById('interest').addEventListener('input', calculateTotal);

        document.getElementById('lendingPaymentForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');

            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ ƒêang x·ª≠ l√Ω...';

            const data = {
                date: document.getElementById('date').value,
                borrowerName: document.getElementById('borrowerName').value,
                principal: document.getElementById('principal').value,
                interest: document.getElementById('interest').value || 0,
                note: document.getElementById('note').value
            };

            google.script.run
                .withSuccessHandler(function (result) {
                    if (result.success) {
                        showMessage(result.message, 'success');
                        document.getElementById('lendingPaymentForm').reset();
                        document.getElementById('date').valueAsDate = new Date();
                        document.getElementById('interest').value = '0';
                        calculateTotal();
                        setTimeout(function () {
                            google.script.host.close();
                        }, 1500);
                    } else {
                        showMessage(result.message, 'error');
                    }
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üí∞ X√°c nh·∫≠n thu ti·ªÅn';
                })
                .withFailureHandler(function (error) {
                    showMessage('L·ªói: ' + error.message, 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üí∞ X√°c nh·∫≠n thu ti·ªÅn';
                })
                .addLendingPayment(data);
        });

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + type;
            messageDiv.style.display = 'block';
            setTimeout(function () {
                messageDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>

</html>