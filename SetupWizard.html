<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Google Sans', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
    }

    .wizard-container {
      max-width: 700px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    .wizard-header {
      background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .wizard-header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .wizard-header p {
      font-size: 14px;
      opacity: 0.9;
    }

    .progress-container {
      background: #f5f5f5;
      padding: 20px 30px;
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      position: relative;
    }

    .progress-step {
      text-align: center;
      flex: 1;
      position: relative;
      z-index: 1;
    }

    .progress-step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #ddd;
      margin: 0 auto 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #666;
      transition: all 0.3s;
    }

    .progress-step.active .progress-step-circle {
      background: #4285f4;
      color: white;
      transform: scale(1.1);
    }

    .progress-step.completed .progress-step-circle {
      background: #34a853;
      color: white;
    }

    .progress-step-label {
      font-size: 12px;
      color: #666;
      font-weight: 500;
    }

    .progress-step.active .progress-step-label {
      color: #4285f4;
      font-weight: bold;
    }

    .progress-line {
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 2px;
      background: #ddd;
      z-index: 0;
    }

    .progress-line-fill {
      height: 100%;
      background: #4285f4;
      transition: width 0.3s;
      width: 0%;
    }

    .wizard-content {
      padding: 30px;
    }

    .step {
      display: none;
    }

    .step.active {
      display: block;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .step-title {
      font-size: 20px;
      color: #333;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .step-description {
      color: #666;
      margin-bottom: 25px;
      font-size: 14px;
    }

    .input-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 500;
      color: #444;
      margin-bottom: 8px;
      font-size: 14px;
    }

    label .required {
      color: #e74c3c;
      margin-left: 3px;
    }

    input,
    select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border 0.3s;
      font-family: inherit;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #4285f4;
    }

    input.error {
      border-color: #e74c3c;
    }

    .helper-text {
      font-size: 12px;
      color: #888;
      margin-top: 5px;
    }

    .radio-group {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }

    .radio-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-weight: normal;
    }

    .radio-label input[type="radio"] {
      width: auto;
      margin-right: 8px;
    }

    .collapsible-content {
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #1976d2;
    }

    .preset-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .preset-btn {
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      background: white;
    }

    .preset-btn:hover {
      border-color: #4285f4;
      background: #f0f7ff;
    }

    .preset-btn.active {
      border-color: #4285f4;
      background: #e3f2fd;
    }

    .preset-btn-title {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 14px;
    }

    .preset-btn-desc {
      font-size: 12px;
      opacity: 0.8;
    }

    .percentage-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .percentage-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .percentage-item label {
      margin: 0;
      flex: 1;
    }

    .percentage-item input {
      width: 80px;
      text-align: center;
      padding: 8px;
    }

    .total-check {
      padding: 12px;
      border-radius: 8px;
      margin-top: 10px;
      font-weight: bold;
      text-align: center;
    }

    .total-check.valid {
      background: #d4edda;
      color: #155724;
    }

    .total-check.invalid {
      background: #f8d7da;
      color: #721c24;
    }

    .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }

    .summary-table th,
    .summary-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
      font-size: 13px;
    }

    .summary-table th {
      background: #f5f5f5;
      font-weight: bold;
      color: #333;
    }

    .summary-table tr:hover {
      background: #f9f9f9;
    }

    .summary-value {
      font-weight: bold;
      color: #667eea;
    }

    .summary-section-header {
      background: #fff3cd !important;
      font-weight: bold !important;
      color: #856404 !important;
    }

    .buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }

    button {
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
      font-family: inherit;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-next {
      background: #4285f4;
      color: white;
    }

    .btn-next:hover:not(:disabled) {
      background: #3367d6;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(66, 133, 244, 0.3);
    }

    .btn-prev {
      background: #e0e0e0;
      color: #333;
    }

    .btn-prev:hover {
      background: #d0d0d0;
    }

    .btn-skip {
      background: #fff;
      color: #666;
      border: 1px solid #ddd;
      margin-right: 10px;
    }

    .btn-skip:hover {
      background: #f5f5f5;
    }

    .btn-finish {
      background: #34a853;
      color: white;
    }

    .btn-finish:hover:not(:disabled) {
      background: #2d8e47;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(52, 168, 83, 0.3);
    }

    .loading {
      display: none;
      text-align: center;
      padding: 60px 20px;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4285f4;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .amount-display {
      text-align: right;
      color: #667eea;
      font-weight: bold;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <div class="wizard-container">
    <div class="wizard-header">
      <h1>üöÄ Thi·∫øt l·∫≠p h·ªá th·ªëng HODLVN</h1>
      <p>Kh·ªüi t·∫°o nhanh d·ªØ li·ªáu ban ƒë·∫ßu cho gia ƒë√¨nh b·∫°n</p>
    </div>

    <div class="progress-container">
      <div class="progress-steps">
        <div class="progress-line">
          <div class="progress-line-fill" id="progressLineFill"></div>
        </div>

        <div class="progress-step active" data-step="1">
          <div class="progress-step-circle">1</div>
          <div class="progress-step-label">S·ªë d∆∞</div>
        </div>

        <div class="progress-step" data-step="2">
          <div class="progress-step-circle">2</div>
          <div class="progress-step-label">N·ª£</div>
        </div>

        <div class="progress-step" data-step="3">
          <div class="progress-step-circle">3</div>
          <div class="progress-step-label">Ng√¢n s√°ch</div>
        </div>

        <div class="progress-step" data-step="4">
          <div class="progress-step-circle">4</div>
          <div class="progress-step-label">X√°c nh·∫≠n</div>
        </div>
      </div>
    </div>

    <div class="wizard-content">
      <!-- B∆Ø·ªöC 1: S·ªê D∆Ø BAN ƒê·∫¶U -->
      <div class="step active" id="step1">
        <h2 class="step-title">üí∞ S·ªë d∆∞ ban ƒë·∫ßu</h2>
        <p class="step-description">Nh·∫≠p s·ªë ti·ªÅn hi·ªán c√≥ c·ªßa gia ƒë√¨nh b·∫°n</p>

        <div class="info-box">
          üí° ƒê√¢y l√† s·ªë ti·ªÅn b·∫°n ƒëang c√≥ (ti·ªÅn m·∫∑t, t√†i kho·∫£n ng√¢n h√†ng, v.v.)
        </div>

        <div class="input-group">
          <label>S·ªë d∆∞ hi·ªán t·∫°i: <span class="required">*</span></label>
          <input type="number" id="initialBalance" placeholder="V√≠ d·ª•: 10000000" min="0" required>
        </div>

        <div class="input-group">
          <label>Ng√†y ghi nh·∫≠n: <span class="required">*</span></label>
          <input type="date" id="balanceDate" required>
        </div>

        <div class="input-group">
          <label>Ngu·ªìn ti·ªÅn: <span class="required">*</span></label>
          <select id="balanceSource" required>
            <option value="">-- Ch·ªçn ngu·ªìn --</option>
            <option value="Ti·ªÅn m·∫∑t">Ti·ªÅn m·∫∑t</option>
            <option value="Ng√¢n h√†ng">Ng√¢n h√†ng</option>
            <option value="V√≠ ƒëi·ªán t·ª≠">V√≠ ƒëi·ªán t·ª≠</option>
            <option value="Kh√°c">Kh√°c</option>
          </select>
        </div>

        <div class="buttons">
          <div></div>
          <button class="btn-next" onclick="goToStep(2)">Ti·∫øp theo ‚Üí</button>
        </div>
      </div>

      <!-- B∆Ø·ªöC 2: TH√îNG TIN N·ª¢ -->
      <div class="step" id="step2">
        <h2 class="step-title">üí≥ Th√¥ng tin n·ª£</h2>
        <p class="step-description">B·∫°n c√≥ kho·∫£n n·ª£ n√†o c·∫ßn qu·∫£n l√Ω kh√¥ng?</p>

        <div class="info-box">
          üí° N·∫øu b·∫°n c√≥ kho·∫£n vay (ng√¢n h√†ng, th√¢n nh√¢n, v.v.), h√£y nh·∫≠p th√¥ng tin ƒë·ªÉ h·ªá th·ªëng gi√∫p theo d√µi
        </div>

        <div class="input-group">
          <label>B·∫°n c√≥ kho·∫£n n·ª£ c·∫ßn qu·∫£n l√Ω?</label>
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" name="hasDebt" value="yes" onchange="toggleDebtFields()">
              C√≥
            </label>
            <label class="radio-label">
              <input type="radio" name="hasDebt" value="no" checked onchange="toggleDebtFields()">
              Kh√¥ng
            </label>
          </div>
        </div>

        <div class="collapsible-content" id="debtFields" style="display: none;">
          <div class="input-group">
            <label>T√™n kho·∫£n n·ª£: <span class="required">*</span></label>
            <input type="text" id="debtName" placeholder="V√≠ d·ª•: Vay mua nh√†">
            <div class="helper-text">ƒê·∫∑t t√™n ƒë·ªÉ d·ªÖ nh·ªõ</div>
          </div>

          <div class="input-group">
            <label>S·ªë ti·ªÅn g·ªëc: <span class="required">*</span></label>
            <input type="number" id="debtPrincipal" placeholder="V√≠ d·ª•: 500000000" min="0">
            <div class="helper-text">S·ªë ti·ªÅn g·ªëc c·∫ßn tr·∫£</div>
          </div>

          <div class="input-group">
            <label>L√£i su·∫•t (%/nƒÉm): <span class="required">*</span></label>
            <input type="number" id="debtRate" placeholder="V√≠ d·ª•: 8.5" step="0.01" min="0" max="100">
            <div class="helper-text">L√£i su·∫•t h√†ng nƒÉm (kh√¥ng ph·∫£i l√£i th√°ng)</div>
          </div>

          <div class="input-group">
            <label>K·ª≥ h·∫°n (th√°ng): <span class="required">*</span></label>
            <input type="number" id="debtTerm" placeholder="V√≠ d·ª•: 240" min="1">
            <div class="helper-text">T·ªïng s·ªë th√°ng tr·∫£ n·ª£</div>
          </div>

          <div class="input-group">
            <label>Ng√†y vay: <span class="required">*</span></label>
            <input type="date" id="debtDate">
          </div>
        </div>

        <div class="buttons">
          <button class="btn-prev" onclick="goToStep(1)">‚Üê Quay l·∫°i</button>
          <div>
            <button class="btn-skip" onclick="skipDebt()">B·ªè qua</button>
            <button class="btn-next" onclick="goToStep(3)">Ti·∫øp theo ‚Üí</button>
          </div>
        </div>
      </div>

      <!-- B∆Ø·ªöC 3: NG√ÇN S√ÅCH -->
      <div class="step" id="step3">
        <h2 class="step-title">üìä Ng√¢n s√°ch h√†ng th√°ng</h2>
        <p class="step-description">Thi·∫øt l·∫≠p k·∫ø ho·∫°ch t√†i ch√≠nh th√¥ng minh</p>

        <!-- 3A: Thu nh·∫≠p -->
        <div id="step3a">
          <div class="info-box">
            üí° <strong>B∆∞·ªõc 3A:</strong> Nh·∫≠p t·ªïng thu nh·∫≠p d·ª± ki·∫øn trong th√°ng
          </div>

          <div class="input-group">
            <label>Thu nh·∫≠p d·ª± ki·∫øn th√°ng n√†y: <span class="required">*</span></label>
            <input type="number" id="income" placeholder="V√≠ d·ª•: 50000000" min="0" step="100000" required>
          </div>

          <div class="buttons">
            <button class="btn-prev" onclick="goToStep(2)">‚Üê Quay l·∫°i</button>
            <button class="btn-next" onclick="goToStep3B()">Ti·∫øp theo ‚Üí</button>
          </div>
        </div>

        <!-- 3B: Ph√¢n b·ªï t·ªïng th·ªÉ -->
        <div id="step3b" style="display: none;">
          <div class="info-box">
            üí° <strong>B∆∞·ªõc 3B:</strong> Ch·ªçn c√°ch ph√¢n b·ªï thu nh·∫≠p v√†o 3 nh√≥m: Chi ti√™u, ƒê·∫ßu t∆∞, Tr·∫£ n·ª£
          </div>

          <div class="input-group">
            <label>Ch·ªçn preset ho·∫∑c t·ª± ƒëi·ªÅu ch·ªânh:</label>
            <div class="preset-buttons">
              <div class="preset-btn" onclick="selectPreset('balanced')">
                <div class="preset-btn-title">‚öñÔ∏è C√¢n b·∫±ng</div>
                <div class="preset-btn-desc">Chi 50% ‚Ä¢ ƒêT 30% ‚Ä¢ N·ª£ 20%</div>
              </div>
              <div class="preset-btn" onclick="selectPreset('aggressive')">
                <div class="preset-btn-title">üí∞ T√≠ch c·ª±c</div>
                <div class="preset-btn-desc">Chi 40% ‚Ä¢ ƒêT 45% ‚Ä¢ N·ª£ 15%</div>
              </div>
              <div class="preset-btn" onclick="selectPreset('debt')">
                <div class="preset-btn-title">üí≥ Tr·∫£ n·ª£</div>
                <div class="preset-btn-desc">Chi 40% ‚Ä¢ ƒêT 10% ‚Ä¢ N·ª£ 50%</div>
              </div>
              <div class="preset-btn active" onclick="selectPreset('custom')">
                <div class="preset-btn-title">üé® T√πy ch·ªânh</div>
                <div class="preset-btn-desc">T·ª± ƒëi·ªÅu ch·ªânh</div>
              </div>
            </div>
          </div>

          <div class="input-group">
            <label>ƒêi·ªÅu ch·ªânh t·ª∑ l·ªá (%):</label>
            <div class="percentage-grid">
              <div class="percentage-item">
                <label>üì§ Chi ti√™u:</label>
                <input type="number" id="pctChi" min="0" max="100" step="5" value="50" oninput="updateTotal()">
                <span>%</span>
              </div>
              <div class="amount-display" id="amountChi">0</div>

              <div class="percentage-item">
                <label>üí∞ ƒê·∫ßu t∆∞:</label>
                <input type="number" id="pctDautu" min="0" max="100" step="5" value="30" oninput="updateTotal()">
                <span>%</span>
              </div>
              <div class="amount-display" id="amountDautu">0</div>

              <div class="percentage-item">
                <label>üí≥ Tr·∫£ n·ª£:</label>
                <input type="number" id="pctTrano" min="0" max="100" step="5" value="20" oninput="updateTotal()">
                <span>%</span>
              </div>
              <div class="amount-display" id="amountTrano">0</div>
            </div>

            <div class="total-check" id="totalCheck">
              T·ªïng: 100% ‚úì
            </div>
          </div>

          <div class="buttons">
            <button class="btn-prev" onclick="backToStep3A()">‚Üê Quay l·∫°i</button>
            <button class="btn-next" id="btnStep3B" onclick="goToStep3C()">Ti·∫øp theo ‚Üí</button>
          </div>
        </div>

        <!-- 3C: Chi ti·∫øt t·ª´ng nh√≥m -->
        <div id="step3c" style="display: none;">
          <div class="info-box">
            üí° <strong>B∆∞·ªõc 3C:</strong> ƒêi·ªÅu ch·ªânh % cho t·ª´ng danh m·ª•c (t·ªïng m·ªói nh√≥m = 100%)
          </div>

          <!-- Chi ti√™u chi ti·∫øt -->
          <div class="input-group">
            <label>üì§ Chi ti√™u chi ti·∫øt:</label>
            <div class="percentage-grid" id="chiDetail"></div>
            <div class="total-check" id="totalChi">T·ªïng: 100% ‚úì</div>
          </div>

          <!-- ƒê·∫ßu t∆∞ chi ti·∫øt -->
          <div class="input-group">
            <label>üí∞ ƒê·∫ßu t∆∞ chi ti·∫øt:</label>
            <div class="percentage-grid" id="dautuDetail"></div>
            <div class="total-check" id="totalDautu">T·ªïng: 100% ‚úì</div>
          </div>

          <div class="buttons">
            <button class="btn-prev" onclick="backToStep3B()">‚Üê Quay l·∫°i</button>
            <button class="btn-next" id="btnStep3C" onclick="goToStep(4)">Ti·∫øp theo ‚Üí</button>
          </div>
        </div>
      </div>

      <!-- B∆Ø·ªöC 4: X√ÅC NH·∫¨N -->
      <div class="step" id="step4">
        <h2 class="step-title">‚úÖ X√°c nh·∫≠n th√¥ng tin</h2>
        <p class="step-description">Ki·ªÉm tra l·∫°i to√†n b·ªô th√¥ng tin tr∆∞·ªõc khi ho√†n t·∫•t</p>

        <table class="summary-table" id="summaryTable"></table>

        <div class="buttons">
          <button class="btn-prev" onclick="goToStep(3)">‚Üê Quay l·∫°i</button>
          <button class="btn-finish" onclick="finishSetup()">‚úÖ Ho√†n t·∫•t thi·∫øt l·∫≠p</button>
        </div>
      </div>

      <!-- LOADING -->
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <h3>ƒêang kh·ªüi t·∫°o h·ªá th·ªëng...</h3>
        <p style="color: #666; margin-top: 10px;">Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t</p>
      </div>
    </div>
  </div>

  <script>
    let currentStep = 1;
    let budgetData = {
      income: 0,
      pctChi: 50,
      pctDautu: 30,
      pctTrano: 20,
      chi: {},
      dautu: {}
    };

    // Preset data
    const presets = {
      balanced: { chi: 50, dautu: 30, trano: 20 },
      aggressive: { chi: 40, dautu: 45, trano: 15 },
      debt: { chi: 40, dautu: 10, trano: 50 },
      custom: { chi: 50, dautu: 30, trano: 20 }
    };

    // Chi ti√™u categories
    const chiCategories = [
      { name: 'ƒÇn u·ªëng', pct: 35 },
      { name: 'ƒêi l·∫°i', pct: 10 },
      { name: 'Nh√† ·ªü', pct: 30 },
      { name: 'Y t·∫ø', pct: 5 },
      { name: 'Gi√°o d·ª•c', pct: 10 },
      { name: 'Mua s·∫Øm', pct: 7 },
      { name: 'Gi·∫£i tr√≠', pct: 2 },
      { name: 'Kh√°c', pct: 1 }
    ];

    // ƒê·∫ßu t∆∞ categories
    const dautuCategories = [
      { name: 'Ch·ª©ng kho√°n', pct: 50 },
      { name: 'V√†ng', pct: 20 },
      { name: 'Crypto', pct: 20 },
      { name: 'ƒê·∫ßu t∆∞ kh√°c', pct: 10 }
    ];

    // Set ng√†y m·∫∑c ƒë·ªãnh l√† h√¥m nay
    document.getElementById('balanceDate').valueAsDate = new Date();
    document.getElementById('debtDate').valueAsDate = new Date();

    // Format currency
    function formatCurrency(amount) {
      return new Intl.NumberFormat('vi-VN').format(Math.round(amount));
    }

    function toggleDebtFields() {
      const hasDebt = document.querySelector('input[name="hasDebt"]:checked').value === 'yes';
      const debtFields = document.getElementById('debtFields');
      debtFields.style.display = hasDebt ? 'block' : 'none';

      if (!hasDebt) {
        document.getElementById('debtName').removeAttribute('required');
        document.getElementById('debtPrincipal').removeAttribute('required');
        document.getElementById('debtRate').removeAttribute('required');
        document.getElementById('debtTerm').removeAttribute('required');
        document.getElementById('debtDate').removeAttribute('required');
      } else {
        document.getElementById('debtName').setAttribute('required', 'required');
        document.getElementById('debtPrincipal').setAttribute('required', 'required');
        document.getElementById('debtRate').setAttribute('required', 'required');
        document.getElementById('debtTerm').setAttribute('required', 'required');
        document.getElementById('debtDate').setAttribute('required', 'required');
      }
    }

    function goToStep(stepNumber) {
      // Validate current step
      if (stepNumber > currentStep && !validateStep(currentStep)) {
        return;
      }

      // Hide all sub-steps of step 3
      if (currentStep === 3) {
        document.getElementById('step3a').style.display = 'none';
        document.getElementById('step3b').style.display = 'none';
        document.getElementById('step3c').style.display = 'none';
      }

      // Hide current step
      document.getElementById('step' + currentStep).classList.remove('active');
      document.querySelector('.progress-step[data-step="' + currentStep + '"]').classList.remove('active');
      if (stepNumber > currentStep) {
        document.querySelector('.progress-step[data-step="' + currentStep + '"]').classList.add('completed');
      }

      // Show new step
      currentStep = stepNumber;
      document.getElementById('step' + currentStep).classList.add('active');
      document.querySelector('.progress-step[data-step="' + currentStep + '"]').classList.add('active');

      // Show first sub-step if going to step 3
      if (currentStep === 3) {
        document.getElementById('step3a').style.display = 'block';
      }

      // Generate summary if going to step 4
      if (currentStep === 4) {
        generateSummary();
      }

      // Update progress line
      const progress = ((currentStep - 1) / 3) * 100;
      document.getElementById('progressLineFill').style.width = progress + '%';

      window.scrollTo(0, 0);
    }

    function validateStep(step) {
      if (step === 3) {
        // Step 3 validation handled in sub-steps
        return true;
      }

      const stepElement = document.getElementById('step' + step);
      const inputs = stepElement.querySelectorAll('input[required], select[required]');
      let isValid = true;

      inputs.forEach(input => {
        if (input.offsetParent === null) {
          input.classList.remove('error');
          return;
        }

        if (!input.value || (input.type === 'number' && parseFloat(input.value) < 0)) {
          input.classList.add('error');
          isValid = false;
        } else {
          input.classList.remove('error');
        }
      });

      if (!isValid) {
        alert('‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc (ƒë√°nh d·∫•u *)');
      }

      return isValid;
    }

    function skipDebt() {
      document.querySelector('input[name="hasDebt"][value="no"]').checked = true;
      toggleDebtFields();
      goToStep(3);
    }

    // Step 3 navigation
    function goToStep3B() {
      const income = parseFloat(document.getElementById('income').value);
      if (!income || income <= 0) {
        alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p thu nh·∫≠p d·ª± ki·∫øn!');
        return;
      }

      budgetData.income = income;
      document.getElementById('step3a').style.display = 'none';
      document.getElementById('step3b').style.display = 'block';
      updateTotal();
      window.scrollTo(0, 0);
    }

    function backToStep3A() {
      document.getElementById('step3b').style.display = 'none';
      document.getElementById('step3a').style.display = 'block';
      window.scrollTo(0, 0);
    }

    function goToStep3C() {
      budgetData.pctChi = parseFloat(document.getElementById('pctChi').value);
      budgetData.pctDautu = parseFloat(document.getElementById('pctDautu').value);
      budgetData.pctTrano = parseFloat(document.getElementById('pctTrano').value);

      document.getElementById('step3b').style.display = 'none';
      document.getElementById('step3c').style.display = 'block';
      generateCategoryInputs();
      window.scrollTo(0, 0);
    }

    function backToStep3B() {
      document.getElementById('step3c').style.display = 'none';
      document.getElementById('step3b').style.display = 'block';
      window.scrollTo(0, 0);
    }

    // Preset selection
    function selectPreset(type) {
      document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
      event.target.closest('.preset-btn').classList.add('active');

      const preset = presets[type];
      document.getElementById('pctChi').value = preset.chi;
      document.getElementById('pctDautu').value = preset.dautu;
      document.getElementById('pctTrano').value = preset.trano;

      updateTotal();
    }

    // Update total percentage
    function updateTotal() {
      const income = budgetData.income || parseFloat(document.getElementById('income').value) || 0;
      const chi = parseFloat(document.getElementById('pctChi').value) || 0;
      const dautu = parseFloat(document.getElementById('pctDautu').value) || 0;
      const trano = parseFloat(document.getElementById('pctTrano').value) || 0;

      const total = chi + dautu + trano;
      const totalCheck = document.getElementById('totalCheck');
      const btn = document.getElementById('btnStep3B');

      document.getElementById('amountChi').textContent = formatCurrency(income * chi / 100);
      document.getElementById('amountDautu').textContent = formatCurrency(income * dautu / 100);
      document.getElementById('amountTrano').textContent = formatCurrency(income * trano / 100);

      if (total === 100) {
        totalCheck.className = 'total-check valid';
        totalCheck.textContent = 'T·ªïng: 100% ‚úì';
        btn.disabled = false;
      } else {
        totalCheck.className = 'total-check invalid';
        totalCheck.textContent = `T·ªïng: ${total}% (C·∫ßn = 100%)`;
        btn.disabled = true;
      }
    }

    // Generate category inputs
    function generateCategoryInputs() {
      const chiDetail = document.getElementById('chiDetail');
      chiDetail.innerHTML = '';
      chiCategories.forEach(cat => {
        chiDetail.innerHTML += `
            <div class="percentage-item">
              <label>${cat.name}:</label>
              <input type="number" class="cat-chi" data-name="${cat.name}" min="0" max="100" step="1" value="${cat.pct}" oninput="updateCategoryTotal('chi')">
              <span>%</span>
            </div>
            <div class="amount-display" id="amount-chi-${cat.name}">0</div>
          `;
      });

      const dautuDetail = document.getElementById('dautuDetail');
      dautuDetail.innerHTML = '';
      dautuCategories.forEach(cat => {
        dautuDetail.innerHTML += `
            <div class="percentage-item">
              <label>${cat.name}:</label>
              <input type="number" class="cat-dautu" data-name="${cat.name}" min="0" max="100" step="1" value="${cat.pct}" oninput="updateCategoryTotal('dautu')">
              <span>%</span>
            </div>
            <div class="amount-display" id="amount-dautu-${cat.name}">0</div>
          `;
      });

      updateCategoryAmounts();
      updateCategoryTotal('chi');
      updateCategoryTotal('dautu');
    }

    // Update category amounts
    function updateCategoryAmounts() {
      const income = budgetData.income;
      const pctChi = budgetData.pctChi / 100;
      const pctDautu = budgetData.pctDautu / 100;

      document.querySelectorAll('.cat-chi').forEach(input => {
        const pct = parseFloat(input.value) || 0;
        const amount = income * pctChi * (pct / 100);
        const name = input.dataset.name;
        const el = document.getElementById(`amount-chi-${name}`);
        if (el) el.textContent = formatCurrency(amount);
      });

      document.querySelectorAll('.cat-dautu').forEach(input => {
        const pct = parseFloat(input.value) || 0;
        const amount = income * pctDautu * (pct / 100);
        const name = input.dataset.name;
        const el = document.getElementById(`amount-dautu-${name}`);
        if (el) el.textContent = formatCurrency(amount);
      });
    }

    // Update category total
    function updateCategoryTotal(type) {
      const inputs = document.querySelectorAll(`#${type}Detail input`);
      let total = 0;
      inputs.forEach(input => {
        total += parseFloat(input.value) || 0;
      });

      const totalDiv = document.getElementById(`total${type.charAt(0).toUpperCase() + type.slice(1)}`);
      const btn = document.getElementById('btnStep3C');

      if (Math.abs(total - 100) < 0.01) {
        totalDiv.className = 'total-check valid';
        totalDiv.textContent = 'T·ªïng: 100% ‚úì';
      } else {
        totalDiv.className = 'total-check invalid';
        totalDiv.textContent = `T·ªïng: ${total.toFixed(1)}% (C·∫ßn = 100%)`;
      }

      const chiTotal = Array.from(document.querySelectorAll('#chiDetail input'))
        .reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
      const dautuTotal = Array.from(document.querySelectorAll('#dautuDetail input'))
        .reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);

      btn.disabled = Math.abs(chiTotal - 100) >= 0.01 || Math.abs(dautuTotal - 100) >= 0.01;

      updateCategoryAmounts();
    }

    // Generate summary
    function generateSummary() {
      // Collect chi data
      budgetData.chi = {};
      document.querySelectorAll('.cat-chi').forEach(input => {
        budgetData.chi[input.dataset.name] = parseFloat(input.value);
      });

      // Collect dautu data
      budgetData.dautu = {};
      document.querySelectorAll('.cat-dautu').forEach(input => {
        budgetData.dautu[input.dataset.name] = parseFloat(input.value);
      });

      const income = budgetData.income;
      const pctChi = budgetData.pctChi / 100;
      const pctDautu = budgetData.pctDautu / 100;
      const pctTrano = budgetData.pctTrano / 100;

      let html = `
          <tr>
            <th colspan="3" style="background: #4285f4; color: white;">üí∞ S·ªê D∆Ø BAN ƒê·∫¶U</th>
          </tr>
          <tr>
            <td>S·ªë d∆∞</td>
            <td colspan="2" class="summary-value">${formatCurrency(parseFloat(document.getElementById('initialBalance').value))}</td>
          </tr>
          <tr>
            <td>Ngu·ªìn</td>
            <td colspan="2">${document.getElementById('balanceSource').value}</td>
          </tr>
          <tr>
            <td>Ng√†y</td>
            <td colspan="2">${document.getElementById('balanceDate').value}</td>
          </tr>
        `;

      // Debt info
      const hasDebt = document.querySelector('input[name="hasDebt"]:checked').value === 'yes';
      if (hasDebt) {
        html += `
            <tr>
              <th colspan="3" style="background: #ea4335; color: white;">üí≥ TH√îNG TIN N·ª¢</th>
            </tr>
            <tr>
              <td>T√™n kho·∫£n n·ª£</td>
              <td colspan="2">${document.getElementById('debtName').value}</td>
            </tr>
            <tr>
              <td>S·ªë ti·ªÅn g·ªëc</td>
              <td colspan="2" class="summary-value">${formatCurrency(parseFloat(document.getElementById('debtPrincipal').value))}</td>
            </tr>
            <tr>
              <td>L√£i su·∫•t</td>
              <td colspan="2">${document.getElementById('debtRate').value}% /nƒÉm</td>
            </tr>
            <tr>
              <td>K·ª≥ h·∫°n</td>
              <td colspan="2">${document.getElementById('debtTerm').value} th√°ng</td>
            </tr>
          `;
      }

      // Budget summary
      html += `
          <tr>
            <th colspan="3" style="background: #34a853; color: white;">üìä NG√ÇN S√ÅCH TH√ÅNG</th>
          </tr>
          <tr>
            <td><strong>Thu nh·∫≠p d·ª± ki·∫øn</strong></td>
            <td>100%</td>
            <td class="summary-value">${formatCurrency(income)}</td>
          </tr>
          <tr class="summary-section-header">
            <td colspan="3">üì§ CHI TI√äU (${budgetData.pctChi}%)</td>
          </tr>
        `;

      Object.entries(budgetData.chi).forEach(([name, pct]) => {
        const amount = income * pctChi * (pct / 100);
        html += `
            <tr>
              <td>&nbsp;&nbsp;‚Ä¢ ${name}</td>
              <td>${pct.toFixed(1)}%</td>
              <td class="summary-value">${formatCurrency(amount)}</td>
            </tr>
          `;
      });

      html += `
          <tr class="summary-section-header">
            <td colspan="3">üí∞ ƒê·∫¶U T∆Ø (${budgetData.pctDautu}%)</td>
          </tr>
        `;

      Object.entries(budgetData.dautu).forEach(([name, pct]) => {
        const amount = income * pctDautu * (pct / 100);
        html += `
            <tr>
              <td>&nbsp;&nbsp;‚Ä¢ ${name}</td>
              <td>${pct.toFixed(1)}%</td>
              <td class="summary-value">${formatCurrency(amount)}</td>
            </tr>
          `;
      });

      html += `
          <tr class="summary-section-header">
            <td colspan="3">üí≥ TR·∫¢ N·ª¢ (${budgetData.pctTrano}%)</td>
          </tr>
          <tr>
            <td>&nbsp;&nbsp;‚Ä¢ Tr·∫£ n·ª£</td>
            <td>100%</td>
            <td class="summary-value">${formatCurrency(income * pctTrano)}</td>
          </tr>
        `;

      document.getElementById('summaryTable').innerHTML = html;
    }

    function finishSetup() {
      // Show loading
      document.querySelectorAll('.step').forEach(s => s.style.display = 'none');
      document.getElementById('loading').classList.add('active');

      // Collect all data
      const setupData = {
        balance: {
          amount: parseFloat(document.getElementById('initialBalance').value),
          date: document.getElementById('balanceDate').value,
          source: document.getElementById('balanceSource').value
        },
        debt: null,
        budget: {
          income: budgetData.income,
          pctChi: budgetData.pctChi,
          pctDautu: budgetData.pctDautu,
          pctTrano: budgetData.pctTrano,
          chi: budgetData.chi,
          dautu: budgetData.dautu
        }
      };

      const hasDebt = document.querySelector('input[name="hasDebt"]:checked').value === 'yes';
      if (hasDebt) {
        setupData.debt = {
          name: document.getElementById('debtName').value,
          principal: parseFloat(document.getElementById('debtPrincipal').value),
          rate: parseFloat(document.getElementById('debtRate').value),
          term: parseInt(document.getElementById('debtTerm').value),
          date: document.getElementById('debtDate').value
        };
      }

      // Call Apps Script
      google.script.run
        .withSuccessHandler(onSetupComplete)
        .withFailureHandler(onSetupError)
        .processSetupWizard(setupData);
    }

    function onSetupComplete(result) {
      if (result.success) {
        alert('üéâ ' + result.message);
        google.script.host.close();
      } else {
        document.getElementById('loading').classList.remove('active');
        document.getElementById('step4').classList.add('active');
        alert('‚ùå ' + result.message);
      }
    }

    function onSetupError(error) {
      document.getElementById('loading').classList.remove('active');
      document.getElementById('step4').classList.add('active');
      alert('‚ùå L·ªói: ' + error.message);
    }

    // Remove error styling on input
    document.querySelectorAll('input, select').forEach(input => {
      input.addEventListener('input', function () {
        this.classList.remove('error');
      });
    });
  </script>
</body>

</html>