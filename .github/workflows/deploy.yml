name: Deploy to Google Apps Script

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          service_account_key: ${{ secrets.SERVICE_ACCOUNT_KEY }}
          export_default_credentials: true
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install clasp
        run: npm install -g @google/clasp
      
      - name: Create .clasp.json
        run: |
          echo '{"scriptId":"${{ secrets.SCRIPT_ID }}","rootDir":"./"}' > .clasp.json
      
      - name: Generate token and push
        run: |
          # Get access token from gcloud
          ACCESS_TOKEN=$(gcloud auth application-default print-access-token)
          
          # Create .clasprc.json with token
          cat > ~/.clasprc.json << EOF
          {
            "token": {
              "access_token": "$ACCESS_TOKEN",
              "token_type": "Bearer"
            }
          }
          EOF
          
          # Push to Apps Script
          clasp push -f